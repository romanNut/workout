<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Streetlifting Analytics Pro</title>
    <style>
        :root { --primary: #2980b9; --bg: #f0f4f8; --card: #ffffff; --accent: #3498db; --sync: #27ae60; --danger: #e74c3c; --dark: #2c3e50; }
        * { touch-action: manipulation; box-sizing: border-box; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px 10px 100px; color: var(--dark); }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 10px; }
        .sync-status { font-size: 11px; color: #7f8c8d; font-weight: bold; }
        .stats-trigger { background: var(--dark); border: none; border-radius: 8px; padding: 10px 15px; font-size: 13px; cursor: pointer; color: #fff; font-weight: bold; }
        
        .tabs, .day-tabs { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 10px; position: sticky; top: 0; background: var(--bg); padding: 5px 0; z-index: 100; scrollbar-width: none; }
        .day-tabs { top: 45px; z-index: 99; border-bottom: 1px solid #d1d8e0; }
        .tab-btn, .day-btn { flex: 1; border: none; padding: 10px 5px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 11px; background: #d1d8e0; white-space: nowrap; }
        .tab-btn.active, .day-btn.active { background: var(--primary); color: white; }
        .day-btn { background: #fff; border: 1px solid #d1d8e0; color: #7f8c8d; }

        .day-content { display: none; }
        .day-content.active { display: block; }
        .day-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); }
        
        .exercise-block { margin-bottom: 12px; padding: 10px; background: #f8fbff; border-radius: 8px; border: 1px solid #edf2f7; }
        .exercise-block.completed { opacity: 0.7; background: #f1f5f9; border-color: var(--sync); }
        .ex-header { font-weight: bold; font-size: 14px; margin-bottom: 8px; color: var(--primary); }
        
        .col-labels { display: flex; gap: 8px; padding-left: 23px; margin: 8px 0 2px; font-size: 9px; color: #94a3b8; font-weight: bold; }
        .set-row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
        
        input { padding: 8px 5px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; text-align: center; }
        .input-w { width: 55px; background: #e1f5fe; color: var(--primary); font-weight: bold; }
        .input-r { width: 45px; }
        input[type="checkbox"] { width: 30px; height: 30px; margin-left: auto; cursor: pointer; }

        #stats-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column; }
        .stats-header { padding: 15px; background: var(--dark); color: white; display: flex; justify-content: space-between; align-items: center; }
        .stats-nav { display: flex; background: #34495e; padding: 8px; gap: 8px; }
        .st-tab { flex: 1; padding: 10px; border: none; background: rgba(255,255,255,0.1); color: #fff; font-size: 11px; font-weight: bold; border-radius: 6px; }
        .st-tab.active { background: var(--accent); }

        .chart-container { padding: 20px 10px; background: #fff; position: relative; height: 220px; }
        .chart-svg { width: 100%; height: 100%; overflow: visible; }
        .chart-line { fill: none; stroke: var(--accent); stroke-width: 3; stroke-linejoin: round; }
        .chart-area { fill: rgba(52, 152, 219, 0.1); }
        .chart-point { r: 7; fill: white; stroke: var(--accent); stroke-width: 3; cursor: pointer; }

        .point-info-bar { display: flex; justify-content: space-around; background: var(--bg); margin: 0 10px 10px; padding: 12px; border-radius: 10px; font-size: 13px; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; border-top: 1px solid #eee; }
        .history-card { background: #fff; border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }

        #timer-widget { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: #1e272e; color: white; padding: 12px 20px; border-radius: 50px; display: none; align-items: center; gap: 15px; z-index: 1001; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .t-input { width: 35px; background: none; border: 1px solid #444; color: white; border-radius: 4px; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <div id="status" class="sync-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button class="stats-trigger" onclick="openStats()">üìä –ü–†–û–ì–†–ï–°–°</button>
    </div>
    <div class="tabs" id="week-tabs"></div>
    <div class="day-tabs" id="day-tabs-row"></div>
    <div id="content"></div>
</div>

<div id="stats-modal">
    <div class="stats-header">
        <h3 style="margin:0">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
        <button onclick="closeStats()" style="background:none; border:none; color:white; font-size:32px;">&times;</button>
    </div>
    <div class="stats-nav">
        <button class="st-tab active" onclick="switchStatTab('mu', this)">–í–´–•–û–î–´</button>
        <button class="st-tab" onclick="switchStatTab('d', this)">–ë–†–£–°–¨–Ø</button>
        <button class="st-tab" onclick="switchStatTab('p', this)">–¢–£–†–ù–ò–ö</button>
    </div>
    <div class="chart-container" id="chart-area"></div>
    <div class="point-info-bar" id="point-details">
        <div>–î–∞—Ç–∞: <b id="det-date">--.--</b></div>
        <div>–í–µ—Å: <b id="det-weight">0</b> –∫–≥</div>
        <div>–ü–æ–≤—Ç: <b id="det-reps">0</b></div>
    </div>
    <div class="history-list" id="history-content"></div>
</div>

<div id="timer-widget">
    <button style="background:none; border:1px solid #555; color:#888; border-radius:50%; width:20px; height:20px; font-size:12px;" onclick="document.getElementById('timer-widget').style.display='none'">&times;</button>
    <div id="t-setup" style="display:flex; align-items:center; gap:5px;">
        <input type="number" id="t-min" value="5" class="t-input">:
        <input type="number" id="t-sec" value="00" class="t-input">
    </div>
    <div id="t-display" style="display:none; font-size:18px; color:var(--sync); font-weight:bold;">05:00</div>
    <button onclick="runTimer()" id="t-btn" style="background:var(--sync); border:none; color:white; border-radius:15px; padding:6px 14px; font-weight:bold;">–°–¢–ê–†–¢</button>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby0THLk5N23Qm8n-aGcudKw0YmgeLzJ8KKeY9KPeM0YQiqlmLbLw_uFmygB4CCHKU1U/exec';
    const muPlan = [6, 5, 4, 3, 2];
    const weeksCfg = [
        {id: 1, w: "30/15/20/10", r: "12"}, {id: 2, w: "30/15/20/10", r: "15"},
        {id: 3, w: "35/20/20/10", r: "12"}, {id: 4, w: "30/15/0/0", r: "10"}
    ];

    let currentWeek = 1, currentDay = "–í—Ç–æ—Ä–Ω–∏–∫", globalData = {}, timerInterval, activeEx = 'mu';

    const fmtDate = (str) => {
        if (!str || str === "undefined" || str === "") return '--.--';
        let clean = String(str).split('T')[0]; 
        let parts = clean.split('-');
        return parts.length === 3 ? `${parts[2]}.${parts[1]}` : clean;
    };

    function generate() {
        const wt = document.getElementById('week-tabs');
        weeksCfg.forEach(w => wt.innerHTML += `<button class="tab-btn" id="wbtn${w.id}" onclick="switchWeek(${w.id})">–ù–µ–¥–µ–ª—è ${w.id}</button>`);
        const dt = document.getElementById('day-tabs-row');
        ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(d => dt.innerHTML += `<button class="day-btn" id="btn-${d}" onclick="switchDay('${d}')">${d.substring(0,2)}</button>`);

        let html = '';
        weeksCfg.forEach(w => {
            let wg = w.w.split('/');
            ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(day => {
                let isL = (day === "–ß–µ—Ç–≤–µ—Ä–≥"), sets = (w.id === 4 && !isL) ? 2 : (isL ? 3 : 5);
                html += `<div id="w${w.id}${day}" class="day-content">
                    <div class="day-card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h3 style="margin:0">${day}</h3>
                            <input type="date" id="w${w.id}${day}dt" class="save-field-dt">
                        </div>
                        ${['mu','d','p'].map((type, i) => {
                            return `<div class="exercise-block">
                                <div class="ex-header">${['–í—ã—Ö–æ–¥—ã','–ë—Ä—É—Å—å—è','–¢—É—Ä–Ω–∏–∫'][i]}</div>
                                <div class="ex-body">
                                    <div class="col-labels"><span>–í–ï–°</span><span style="margin-left:36px">–ü–û–í–¢</span></div>
                                    ${Array.from({length: (i===0?5:sets)}).map((_,si)=> {
                                        let pW = (i === 0) ? 0 : (isL ? wg[i+1] : wg[i-1]);
                                        let pR = (i === 0) ? muPlan[si] : (isL ? 10 : w.r);
                                        return `<div class="set-row">
                                            <span style="font-size:10px; color:#999">${si+1}</span>
                                            <input type="number" class="input-w save-field" id="w${w.id}${day}${type}${si+1}w" value="${pW}">
                                            <input type="number" class="input-r save-field" id="w${w.id}${day}${type}${si+1}r" value="${pR}">
                                            <input type="checkbox" id="w${w.id}${day}${type}${si+1}c" class="check-field">
                                        </div>`}).join('')}
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            });
        });
        document.getElementById('content').innerHTML = html;
        document.querySelectorAll('.save-field').forEach(el => el.addEventListener('change', (e) => save(e.target.id, e.target.value)));
        document.querySelectorAll('.save-field-dt').forEach(el => el.addEventListener('input', (e) => save(e.target.id, e.target.value)));
        document.querySelectorAll('.check-field').forEach(el => el.addEventListener('change', (e) => {
            handleCheck(e.target);
        }));
        load();
    }

    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: —á–µ–∫–±–æ–∫—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ —á–∏—Å–ª–∞ –∏–∑ –ø–æ–ª–µ–π –≤–µ—Å–∞ –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤
    async function handleCheck(target) {
        const baseId = target.id.slice(0, -1); // —É–±–∏—Ä–∞–µ–º 'c' –≤ –∫–æ–Ω—Ü–µ
        const wVal = document.getElementById(baseId + 'w').value;
        const rVal = document.getElementById(baseId + 'r').value;
        
        // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
        globalData[target.id] = target.checked;
        globalData[baseId + 'w'] = wVal;
        globalData[baseId + 'r'] = rVal;

        updateComp();

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–∫–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–æ
        document.getElementById('status').innerText = 'Sync...';
        try {
            await fetch(SCRIPT_URL, {
                method:'POST', 
                mode:'no-cors', 
                body:JSON.stringify({
                    [target.id]: target.checked,
                    [baseId + 'w']: wVal,
                    [baseId + 'r']: rVal
                })
            });
            document.getElementById('status').innerText = 'Saved';
        } catch(e) { document.getElementById('status').innerText = 'Offline'; }

        if(target.checked) { 
            document.getElementById('timer-widget').style.display = 'flex'; 
            resetT(); 
        }
    }

    async function save(id, val) {
        globalData[id] = val;
        document.getElementById('status').innerText = 'Sync...';
        try { 
            await fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({[id]:val})});
            document.getElementById('status').innerText = 'Saved';
        } catch(e) { document.getElementById('status').innerText = 'Offline'; }
    }

    async function load() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            globalData = data;
            for(let id in data) {
                let el = document.getElementById(id);
                if(el) {
                    if(el.type === 'checkbox') el.checked = (data[id] === 'true' || data[id] === true);
                    else if(el.type === 'date') el.value = data[id].split('T')[0];
                    else el.value = data[id];
                }
            }
            if(data.active_week) switchWeek(parseInt(data.active_week), true);
            if(data.active_day) switchDay(data.active_day, true);
            document.getElementById('status').innerText = 'Cloud Active';
        } catch(e) { switchWeek(1, true); }
    }

    function switchWeek(n, s) { currentWeek = n; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id === `wbtn${n}`)); update(); if(!s) save('active_week', n); }
    function switchDay(d, s) { currentDay = d; document.querySelectorAll('.day-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${d}`)); update(); if(!s) save('active_day', d); }
    function update() { document.querySelectorAll('.day-content').forEach(el => el.classList.toggle('active', el.id === `w${currentWeek}${currentDay}`)); updateComp(); }
    function updateComp() { document.querySelectorAll('.exercise-block').forEach(b => { const c = b.querySelectorAll('.check-field'); if(c.length) b.classList.toggle('completed', Array.from(c).every(i => i.checked)); }); }

    function resetT() { if(timerInterval) clearInterval(timerInterval); document.getElementById('t-display').style.display='none'; document.getElementById('t-setup').style.display='flex'; document.getElementById('t-btn').innerText = '–°–¢–ê–†–¢'; }
    function runTimer() {
        let btn = document.getElementById('t-btn'), disp = document.getElementById('t-display'), setup = document.getElementById('t-setup');
        if(btn.innerText === '–°–¢–ê–†–¢') {
            btn.innerText = '–°–¢–û–ü';
            let t = (parseInt(document.getElementById('t-min').value)||0)*60 + (parseInt(document.getElementById('t-sec').value)||0);
            if(t <= 0) t = 300;
            setup.style.display = 'none'; disp.style.display = 'block';
            timerInterval = setInterval(() => {
                let m = Math.floor(t/60), s = t%60;
                disp.innerText = `${m}:${s<10?'0':''}${s}`;
                if(--t < 0) { clearInterval(timerInterval); btn.innerText = '–û–ö'; }
            }, 1000);
        } else { resetT(); if(btn.innerText === '–û–ö') document.getElementById('timer-widget').style.display = 'none'; }
    }

    function openStats() { document.getElementById('stats-modal').style.display = 'flex'; renderStats(); }
    function closeStats() { document.getElementById('stats-modal').style.display = 'none'; }
    function switchStatTab(ex, btn) { activeEx = ex; document.querySelectorAll('.st-tab').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderStats(); }

    function renderStats() {
        const hCont = document.getElementById('history-content');
        const cArea = document.getElementById('chart-area');
        let history = [];

        for(let w=1; w<=4; w++) {
            ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(day => {
                let mW = 0, tR = 0, has = false;
                let dDt = globalData[`w${w}${day}dt`] || "";

                for(let s=1; s<=5; s++){
                    // –¢–ï–ü–ï–†–¨ –°–¢–†–û–ì–û –ü–†–û–í–ï–†–Ø–ï–ú –¢–û–õ–¨–ö–û –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ß–ï–ö–ë–û–ö–°–ê–ú–ò –ü–û–î–•–û–î–´
                    let isDone = globalData[`w${w}${day}${activeEx}${s}c`] === 'true' || globalData[`w${w}${day}${activeEx}${s}c`] === true;
                    if(isDone) {
                        has = true;
                        let wv = parseFloat(globalData[`w${w}${day}${activeEx}${s}w`]);
                        let rv = parseFloat(globalData[`w${w}${day}${activeEx}${s}r`]);
                        if(!isNaN(wv) && wv > mW) mW = wv;
                        if(!isNaN(rv)) tR += rv;
                    }
                }
                if(has) history.push({date: dDt, weight: mW, reps: tR, day: day});
            });
        }

        if(!history.length) { hCont.innerHTML = '<p style="text-align:center; padding:20px;">–û—Ç–º–µ—Ç—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –≥–∞–ª–æ—á–∫–æ–π</p>'; cArea.innerHTML = ''; return; }
        history.sort((a,b) => (a.date || "0") > (b.date || "0") ? 1 : -1);

        const weights = history.map(x => x.weight), minW = Math.min(...weights), maxW = Math.max(...weights);
        const range = (maxW - minW) || 10;
        const W = cArea.clientWidth - 40, H = 180;

        const pts = history.map((h, i) => ({
            x: (i * W / (history.length > 1 ? history.length - 1 : 1)) + 20,
            y: H - ((h.weight - minW) / range * (H-60)) - 30,
            h: h
        }));

        cArea.innerHTML = `<svg class="chart-svg" viewBox="0 0 ${cArea.clientWidth} ${H}">
            <path class="chart-area" d="M ${pts[0].x} ${H} L ${pts.map(p=>`${p.x} ${p.y}`).join(' L ')} L ${pts[pts.length-1].x} ${H} Z" />
            <path class="chart-line" d="M ${pts.map(p=>`${p.x} ${p.y}`).join(' L ')}" />
            ${pts.map(p=>`<circle class="chart-point" cx="${p.x}" cy="${p.y}" onclick="showDet('${p.h.date}',${p.h.weight},${p.h.reps})"/>`).join('')}
        </svg>`;

        hCont.innerHTML = history.slice().reverse().map(h => `
            <div class="history-card">
                <div><b>${fmtDate(h.date)}</b><br><small>${h.day}</small></div>
                <div style="text-align:right"><b>${h.weight} –∫–≥</b><br><small>${h.reps} –ø–æ–≤—Ç</small></div>
            </div>`).join('');
    }

    function showDet(d,w,r) {
        document.getElementById('det-date').innerText = fmtDate(d);
        document.getElementById('det-weight').innerText = w;
        document.getElementById('det-reps').innerText = r;
    }

    generate();
</script>
</body>
</html>