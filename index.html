<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>STREETLIFTING PRO</title>
    <link rel="apple-touch-icon" href="apple-touch-icon.png">

<meta name="apple-mobile-web-app-title" content="SL Pro">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { 
            --primary: #2980b9; --bg: #f0f4f8; --card: #ffffff; --accent: #3498db; 
            --sync: #27ae60; --danger: #e74c3c; --dark: #2c3e50; --warning: #f39c12; 
        }
        html, body { max-width: 100vw; overflow-x: hidden; position: relative; margin: 0; padding: 0; width: 100%; touch-action: manipulation; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); padding: 10px 10px 100px; color: var(--dark); }

        .header-row { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 10px; }
        .sync-status { font-size: 11px; color: #7f8c8d; font-weight: bold; }
        .stats-trigger { background: var(--dark); border: none; border-radius: 8px; padding: 10px 15px; font-size: 13px; cursor: pointer; color: #fff; font-weight: bold; }
        
        .tabs, .day-tabs { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 10px; position: sticky; top: 0; background: var(--bg); padding: 5px 0; z-index: 100; scrollbar-width: none; }
        .tabs::-webkit-scrollbar { display: none; }
        .day-tabs { top: 45px; z-index: 99; border-bottom: 1px solid #d1d8e0; padding-bottom: 10px; }

        .tab-btn { flex: 1; border: none; padding: 12px 10px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 11px; background: #d1d8e0; white-space: nowrap; position: relative; color: #2c3e50; }
        .tab-btn.active { background: var(--primary); color: white; }
        .progress-mini { position: absolute; bottom: 0; left: 0; height: 4px; background: var(--sync); transition: width 0.3s; width: 0%; }
        
        .day-btn { flex: 1; border: none; padding: 10px; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 11px; background: #fff; border: 1px solid #d1d8e0; }
        .day-btn.active { background: var(--primary); color: white; }

        .day-card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid var(--primary); width: 100%; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .exercise-block { margin-bottom: 12px; padding: 10px; background: #f8fbff; border-radius: 8px; border: 1px solid #edf2f7; overflow: hidden; transition: opacity 0.3s ease; }
        .exercise-block.completed { opacity: 0.35; }
        
        .ex-header { font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .ex-content { transition: max-height 0.3s ease-out; max-height: 1200px; }
        .ex-content.collapsed { max-height: 0 !important; visibility: hidden; }
        
        .warmup-hint-btn { background: #e1f5fe; color: var(--primary); border: 1px solid var(--primary); width: 32px; height: 26px; border-radius: 6px; font-size: 14px; display: flex; align-items: center; justify-content: center; margin-left: auto; margin-right: 10px; }
        .collapse-icon { font-size: 12px; color: #94a3b8; transition: transform 0.3s; }
        .collapsed-header .collapse-icon { transform: rotate(-90deg); }

        .col-labels { display: flex; gap: 8px; padding-left: 23px; margin: 8px 0 2px; font-size: 9px; color: #94a3b8; font-weight: bold; }
        .set-row { display: flex; align-items: center; gap: 6px; margin-top: 6px; }
        input { padding: 8px 5px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 16px; text-align: center; }
        .input-w { width: 55px; background: #e1f5fe; color: var(--primary); font-weight: bold; }
        .input-r { width: 45px; }
        .check-container { flex: 1; display: flex; justify-content: flex-end; align-items: center; gap: 8px; }
        input[type="checkbox"] { width: 32px; height: 32px; margin: 0; }
        
        .rpe-badge { font-size: 9px; width: 42px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 6px; font-weight: 800; border: 1px solid rgba(0,0,0,0.1); }
        
        #timer-widget { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: #1e272e; color: white; padding: 12px 20px; border-radius: 50px; display: none; align-items: center; gap: 12px; z-index: 1001; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #stats-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 2000; display: none; flex-direction: column; }
        .chart-container { padding: 20px 10px; height: 220px; position: relative; width: 100%; }
        #warmup-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 16px; z-index: 4000; display: none; width: 85%; max-width: 300px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    
        
    
    
    /* –≤—ã–≥—Ä—É–∑–∫–∞ */
@media print {
    body * { visibility: hidden; }  
    #print-section, #print-section * { visibility: visible; }
    #print-section { position: absolute; left: 0; top: 0; width: 100%; background: white; color: #000; }
    .page-break { page-break-after: always; padding: 15px; box-sizing: border-box; }
    
    html, body {
        width: 210mm !important; /* –ù–∞—Å–∏–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º —à–∏—Ä–∏–Ω—É A4 */
        height: auto !important;
        overflow: visible !important;
        margin: 0 !important;
        padding: 0 !important;
        position: static !important;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 4px; table-layout: fixed; border: 1.2px solid #000; }
    th, td { border: 1px solid #000; padding: 2px; text-align: center; font-size: 8pt; overflow: hidden; }
    
    /* –ù–æ–≤—ã–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∫–æ–ª–æ–Ω–æ–∫ */
    .col-name { width: 40%; text-align: left !important; padding-left: 5px !important; font-size: 7.5pt !important; }
    .col-set { width: 12%; }

    .bg-done { background-color: #d4edda !important; -webkit-print-color-adjust: exact; }
    .bg-missed { background-color: #f8d7da !important; -webkit-print-color-adjust: exact; }
    
    .chart-svg { width: 100%; height: 80px; margin-top: 5px; }
    .chart-line { fill: none; stroke: #2980b9; stroke-width: 2; }
    .chart-point { fill: #2c3e50; }
}
    
    
    
    
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<div class="container">
    <div class="header-row">
        <div id="status" class="sync-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div style="display:flex; gap:5px;">
            <button class="stats-trigger" style="background:var(--dark)" onclick="openModal('new-cycle-modal')  ">‚úö</button>
            <button class="stats-trigger" onclick="openStats()">üìä</button>
            <button onclick="generateShareCard()" style="background:var(--dark); color:white; border:none; border-radius:8px; padding:8px 12px; font-size:18px;">üì∏</button>
            <button onclick="generatePrintVersion()" style="background:var(--dark); color:white; border:none; border-radius:8px; padding:8px 12px; font-size:18px;">üì•</button>
        </div>
    </div>
    <div id="cycle-tabs" class="tabs"></div>
    <div id="week-tabs" class="tabs"></div>
    <div id="day-tabs-row" class="day-tabs"></div>
    <div id="content"></div>
</div>

<div id="new-cycle-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:3000; display:none; flex-direction:column; padding:20px;">
    <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h2>
    <div style="margin-bottom:15px"><label style="display:block; font-size:12px; color:#777; margin-bottom:5px">–ë–†–£–°–¨–Ø (–±–∞–∑–∞ –∫–≥)</label><input type="number" id="base-d" value="30" style="width:100%; padding:15px; font-size:20px"></div>
    <div style="margin-bottom:15px"><label style="display:block; font-size:12px; color:#777; margin-bottom:5px">–¢–£–†–ù–ò–ö (–±–∞–∑–∞ –∫–≥)</label><input type="number" id="base-p" value="20" style="width:100%; padding:15px; font-size:20px"></div>
    <div style="margin-bottom:15px"><label style="display:block; font-size:12px; color:#777; margin-bottom:5px">–í–´–•–û–î–´ (–±–∞–∑–∞ –∫–≥)</label><input type="number" id="base-m" value="0" style="width:100%; padding:15px; font-size:20px"></div>
    <button id="gen-btn" class="stats-trigger" style="width:100%; padding:20px; background:var(--sync)" onclick="createNewCycle()">–°–û–ó–î–ê–¢–¨ –ë–õ–û–ö</button>
    <button onclick="closeModal('new-cycle-modal')" style="margin-top:10px; background:none; border:none; color:gray">–û—Ç–º–µ–Ω–∞</button>
</div>



<div id="notes-block" class="exercise-block" style="margin-top: 20px;">
    <div class="ex-header" onclick="toggleNotes()">
        <span>üìù –ó–∞–º–µ—Ç–∫–∏ –∫ –±–ª–æ–∫—É</span>
        <span id="notes-icon" class="collapse-icon" style="transform: rotate(-90deg);">‚ñº</span>
    </div>
    <div id="notes-content" class="ex-content collapsed">
        <div style="padding: 10px 0;">
            <textarea id="cycle-notes" 
                      placeholder="–°–æ–Ω, –ø–∏—Ç–∞–Ω–∏–µ, —Ç—Ä–∞–≤–º—ã, —Å–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ '-'..." 
                      style="width: 100%; min-height: 100px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-family: inherit; font-size: 14px; box-sizing: border-box; resize: none; overflow: hidden;"
                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'; syncNotes(this.value)"></textarea>
        </div>
    </div>
</div>

<div id="warmup-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3999; display:none;" onclick="closeWarmup()"></div>
<div id="warmup-modal">
    <h3 id="warmup-title" style="margin:0 0 15px 0; text-align:center;">–†–∞–∑–º–∏–Ω–∫–∞</h3>
    <div id="warmup-list"></div>
    <button class="stats-trigger" style="width:100%; margin-top:15px; background:var(--primary);" onclick="closeWarmup()">–ó–ê–ö–†–´–¢–¨</button>
</div>

<div id="timer-widget">
    <div id="t-setup" style="display:flex;"><input type="number" id="t-min" value="5" style="width:40px; background:none; color:white; border:none">:<input type="number" id="t-sec" value="00" style="width:40px; background:none; color:white; border:none"></div>
    <div id="t-display" style="display:none; font-weight:bold; color:var(--sync)">05:00</div>
    <button id="t-btn" onclick="runTimer()" style="background:var(--sync); border:none; color:white; border-radius:15px; padding:5px 15px;">–°–¢–ê–†–¢</button>
    <div onclick="closeTimer()" style="color:var(--danger); font-weight:bold; cursor:pointer; margin-left:10px;">&times;</div>
</div>

<div id="stats-modal">
    <div style="background:var(--dark); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;"><h3>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3><button onclick="closeStats()" style="background:none; border:none; color:white; font-size:32px;">&times;</button></div>
    <div style="display:flex; background:#34495e; padding:10px; gap:5px; overflow-x:auto;"><button class="tab-btn active" id="st-d" onclick="updateChart('d', this)">–ë—Ä—É—Å—å—è</button><button class="tab-btn" id="st-p" onclick="updateChart('p', this)">–¢—É—Ä–Ω–∏–∫</button><button class="tab-btn" id="st-mu" onclick="updateChart('mu', this)">–í—ã—Ö–æ–¥—ã</button></div>
    <div id="chart-container" class="chart-container"></div>
    <div id="history-content" style="flex:1; overflow-y:auto; padding:10px;"></div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby0THLk5N23Qm8n-aGcudKw0YmgeLzJ8KKeY9KPeM0YQiqlmLbLw_uFmygB4CCHKU1U/exec';
    let curC = 1, curW = 1, curD = "–í—Ç–æ—Ä–Ω–∏–∫", globalData = {}, tInt;

    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑—É–º–∞
    document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
    let lastTouch = 0;
    document.addEventListener('touchend', (e) => { const now = Date.now(); if (now - lastTouch <= 300) e.preventDefault(); lastTouch = now; }, false);

    const RPE_MAP = {
        'none': { label: '‚Äî', color: '#eeeeee', text: '#7f8c8d' },
        'easy': { label: 'easy', color: '#3498db', text: '#ffffff' },
        'ok': { label: 'ok', color: '#27ae60', text: '#ffffff' },
        'hard': { label: 'hard', color: '#f39c12', text: '#ffffff' },
        'fail': { label: 'fail', color: '#e74c3c', text: '#ffffff' }
    };

    async function load() {
        try {
            document.getElementById('status').innerText = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            const res = await fetch(SCRIPT_URL + '?t=' + Date.now());
            const data = await res.json();
            globalData = {}; 
            for (let key in data) { if (data[key] !== "") globalData[key] = data[key]; }
            initInterface();
        } catch(e) { document.getElementById('status').innerText = '–û—Ñ—Ñ–ª–∞–π–Ω'; }
    }

    function initInterface() {
        const maxCycle = parseInt(globalData.last_cycle_id) || 0;
        if(maxCycle === 0) {
            document.getElementById('status').innerText = '–ù–µ—Ç –±–ª–æ–∫–æ–≤';
            return;
        }
        if(!window.loaded) { curC = maxCycle; window.loaded = true; }
        curW = parseInt(globalData[`c${curC}_actW`]) || 1;
        curD = globalData[`c${curC}_actD`] || "–í—Ç–æ—Ä–Ω–∏–∫";
        renderCycles(maxCycle);
        renderMain();
        updateAllProgress();
        refreshNotesField();
        document.getElementById('status').innerText = '–ì–æ—Ç–æ–≤–æ';
    }

    function renderCycles(max) {
        const ct = document.getElementById('cycle-tabs');
        ct.innerHTML = '';
        for(let i=1; i<=max; i++) {
            if(!globalData[`c${i}_created`]) continue;
            let d = new Date(globalData[`c${i}_created`]);
            let lbl = d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});
            ct.innerHTML += `<button class="tab-btn ${curC==i?'active':''}" onclick="switchCycle(${i})">–ë–ª–æ–∫ ${lbl}</button>`;
        }
    }

    function renderMain() {
        const contentDiv = document.getElementById('content');
        if (!globalData[`c${curC}_created`]) {
            contentDiv.innerHTML = '<center style="padding:40px">–ë–ª–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</center>';
            return;
        }

        let html = `<div class="day-card">
            <div class="card-header">
                <h3 style="margin:0">${curD}</h3>
                <input type="date" id="c${curC}_w${curW}${curD}dt" style="font-size:12px; padding:5px; border-radius:6px; border:1px solid #ddd" value="${(globalData[`c${curC}_w${curW}${curD}dt`]||'').split('T')[0]}" onchange="save(this.id, this.value)">
            </div>`;
        
        ['mu','d','p'].forEach(type => {
            const name = type==='mu'?'–í—ã—Ö–æ–¥—ã':(type==='d'?'–ë—Ä—É—Å—å—è':'–¢—É—Ä–Ω–∏–∫');
            const blockId = `${curC}${curW}${curD}${type}`;
            const sMax = getSetsCount(type, curW, curD);
            let allChecked = true;
            let blockHtml = '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –Ω—É–∂–Ω–æ –ª–∏ —Å–≤–µ—Ä–Ω—É—Ç—å –±–ª–æ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–í—ã—Ö–æ–¥—ã)
            const isMU = type === 'mu';

            for(let s=1; s<=sMax; s++) {
                let id = `c${curC}_w${curW}${curD}${type}${s}`;
                let isChecked = globalData[id+'c'] == 'true' || globalData[id+'c'] === true;
                if(!isChecked) allChecked = false;
                
                blockHtml += `<div class="set-row">
                    <span style="width:15px; font-size:10px; color:#999">${s}</span>
                    <input type="number" class="input-w" id="${id}w" value="${globalData[id+'w']||0}" onchange="save(this.id, this.value)">
                    <input type="number" class="input-r" id="${id}r" value="${globalData[id+'r']||0}" onchange="save(this.id, this.value)">
                    <div class="check-container">
                        <div id="${id}rpe" class="rpe-badge" onclick="cycleRPE('${id}')"></div>
                        <input type="checkbox" id="${id}c" ${isChecked?'checked':''} onchange="hCh(this, '${blockId}')">
                    </div>
                </div>`;
                setTimeout(() => applyRPEStyle(document.getElementById(id+'rpe'), globalData[id+'rpe']||'none'), 0);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã collapsed –∏ collapsed-header –µ—Å–ª–∏ —ç—Ç–æ –í—ã—Ö–æ–¥—ã –∏ –æ–Ω–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
            const collapseClass = (isMU && !allChecked) ? 'collapsed' : '';
            const headerCollapseClass = (isMU && !allChecked) ? 'collapsed-header' : '';

            html += `<div id="block-${blockId}" class="exercise-block ${allChecked?'completed':''} ${headerCollapseClass}">
                <div class="ex-header" onclick="toggleBlock('${blockId}', this)">
                    <span>${name}</span>
                    <button class="warmup-hint-btn" onclick="event.stopPropagation(); showWarmup('${name}','${type}')">üí°</button>
                    <span class="collapse-icon">‚ñº</span>
                </div>
                <div id="content-${blockId}" class="ex-content ${collapseClass}">
                    <div class="col-labels"><span>–í–ï–°</span><span style="margin-left:35px">–ü–û–í–¢</span><span style="margin-left:115px">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</span></div>
                    ${blockHtml}
                </div></div>`;
        });
        contentDiv.innerHTML = html + `</div>`;
        renderTabsUI();
    }

    async function save(id, val) {
        globalData[id] = val;
        document.getElementById('status').innerText = '–ó–∞–ø–∏—Å—å...';
        await fetch(SCRIPT_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({[id]:val})});
        document.getElementById('status').innerText = '–ì–æ—Ç–æ–≤–æ';
    }

    async function hCh(target, blockId) {
        const dtI = document.getElementById(`c${curC}_w${curW}${curD}dt`);
        if(target.checked && !dtI.value) {
            const today = new Date().toISOString().split('T')[0];
            dtI.value = today; save(dtI.id, today);
        }
        globalData[target.id] = target.checked;
        save(target.id, target.checked);
        
        const block = document.getElementById('block-'+blockId);
        const checks = block.querySelectorAll('input[type="checkbox"]');
        let allDone = true;
        checks.forEach(c => { if(!c.checked) allDone = false; });
        block.classList.toggle('completed', allDone);

        updateAllProgress();
        // if(target.checked) { document.getElementById('timer-widget').style.display='flex'; resetT(); }
    }

    async function createNewCycle() {
    const btn = document.getElementById('gen-btn');
    btn.disabled = true; 
    btn.innerText = '–ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ó–ê–ü–ò–°–¨...';
    
    let nId = (parseInt(globalData.last_cycle_id) || 0) + 1;
    let plan = {};
    
    // 1. –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ
    plan[`c${nId}_created`] = new Date().toISOString();
    plan[`c${nId}_actW`] = 1;
    plan[`c${nId}_actD`] = "–í—Ç–æ—Ä–Ω–∏–∫";
    plan[`last_cycle_id`] = nId;

    const bD = parseFloat(document.getElementById('base-d').value) || 0;
    const bP = parseFloat(document.getElementById('base-p').value) || 0;
    const bM = parseFloat(document.getElementById('base-m').value) || 0;

    // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–µ—Å—å –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏
    [1,2,3,4].forEach(w => {
        ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(day => {
            ['mu','d','p'].forEach(ex => {
                let base = (ex === 'mu' ? bM : (ex === 'd' ? bD : bP));
                let sMax = getSetsCount(ex, w, day);
                for(let s = 1; s <= sMax; s++) {
                    let wt = 0, rp = 0;
                    if(ex === 'mu'){ 
                        wt = base; 
                        rp = (w === 4) ? [3,2,1,1,1][s-1] : [6,5,4,3,2][s-1]; 
                    } else {
                        if(day === "–ß–µ—Ç–≤–µ—Ä–≥") { wt = Math.floor(base * 0.5); rp = 10; } 
                        else { 
                            if(w === 1){ wt = base; rp = 12 } 
                            else if(w === 2){ wt = base; rp = 15 } 
                            else if(w === 3){ wt = base + 5; rp = 12 } 
                            else { wt = base; rp = 10 } 
                        }
                    }
                    let id = `c${nId}_w${w}${day}${ex}${s}`;
                    plan[id+'w'] = wt; 
                    plan[id+'r'] = rp; 
                    plan[id+'c'] = false; 
                    plan[id+'rpe'] = 'none';
                }
            });
        });
    });

    // 3. –û–¢–ü–†–ê–í–õ–Ø–ï–ú –í–°–Å –û–î–ù–ò–ú –ü–ê–ö–ï–¢–û–ú
    try {
        await fetch(SCRIPT_URL, {
            method: 'POST', 
            mode: 'no-cors', // –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è Google Script
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(plan)
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
        Object.assign(globalData, plan);
        curC = nId;
        closeModal('new-cycle-modal');
        initInterface(); 
    } catch(e) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + e);
    } finally {
        btn.disabled = false;
        btn.innerText = '–°–û–ó–î–ê–¢–¨ –ë–õ–û–ö';
    }
}

    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    function updateChart(type, btn) {
        document.querySelectorAll('#stats-modal .tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const hCont = document.getElementById('history-content'), cArea = document.getElementById('chart-container');
        let history = [];
        for(let w=1; w<=4; w++){
            ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(day => {
                let date = globalData[`c${curC}_w${w}${day}dt`];
                let sets = [];
                let fw = null;
                for(let s=1; s<=getSetsCount(type, w, day); s++) {
                    let id = `c${curC}_w${w}${day}${type}${s}`;
                    if(globalData[id+'c'] == 'true' || globalData[id+'c'] === true) {
                        sets.push(`${globalData[id+'w']}√ó${globalData[id+'r']}`);
                        if(fw === null) fw = parseFloat(globalData[id+'w']);
                    }
                }
                if(date && sets.length) history.push({ date, weight: fw, sets: sets.join(', ') });
            });
        }
        if(!history.length) { hCont.innerHTML = '<center>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</center>'; cArea.innerHTML=''; return; }
        history.sort((a,b)=>new Date(a.date)-new Date(b.date));
        const W=cArea.clientWidth, H=180;
        const weights=history.map(h=>h.weight), minW=Math.min(...weights), maxW=Math.max(...weights), rng=(maxW-minW)||10;
        const pts=history.map((h,i)=>({x:(i*(W-60)/(history.length-1||1))+30, y:H-((h.weight-minW)/rng*(H-60))-30}));
        cArea.innerHTML = `<svg width="${W}" height="${H}">
            ${pts.map((p,i)=>i>0?`<line x1="${pts[i-1].x}" y1="${pts[i-1].y}" x2="${p.x}" y2="${p.y}" stroke="var(--accent)" stroke-width="3"/>`:'').join('')}
            ${pts.map(p=>`<circle cx="${p.x}" cy="${p.y}" r="5" fill="var(--primary)" stroke="white" stroke-width="2"/>`).join('')}
            ${pts.map((p,i)=>`<text x="${p.x}" y="${p.y-12}" font-size="10" text-anchor="middle" font-weight="bold">${history[i].weight}</text>`).join('')}
        </svg>`;
        hCont.innerHTML = history.reverse().map(h=>`<div style="padding:12px; border-bottom:1px solid #eee"><b>${new Date(h.date).toLocaleDateString()}</b>: ${h.weight}–∫–≥ <br><small>${h.sets}</small></div>`).join('');
    }

    function showWarmup(name, type) {
        const id1 = `c${curC}_w${curW}${curD}${type}1w`;
        const fW = parseFloat(globalData[id1] || 0);
        const list = document.getElementById('warmup-list'); list.innerHTML = '';
        const reps = type === 'mu' ? [5, 4, 3] : [12, 10, 8];
        [40, 60, 80].forEach((p, i) => {
            let w = Math.round((fW * p / 100) / 2.5) * 2.5;
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee"><b>${p}% (${w} –∫–≥)</b> <span>${reps[i]} –ø–æ–≤—Ç.</span></div>`;
        });
        document.getElementById('warmup-title').innerText = name;
        document.getElementById('warmup-overlay').style.display = 'block';
        document.getElementById('warmup-modal').style.display = 'block';
    }

// –≤—ã–≥—Ä—É–∑–∫–∞
function generatePrintVersion() {
    const old = document.getElementById('print-section');
    if (old) old.remove();

    const printSection = document.createElement('div');
    printSection.id = 'print-section';
    
    const lastId = parseInt(globalData.last_cycle_id) || 0;
    let fullHtml = '';

    for (let c = 1; c <= lastId; c++) {
        if (!globalData[`c${c}_created`]) continue;
        const dateStr = new Date(globalData[`c${c}_created`]).toLocaleDateString('ru-RU');
        let stats = { mu: [], d: [], p: [] };

        fullHtml += `<div class="page-break" style="page-break-after: always; padding: 15px; font-family: sans-serif;">
            <div style="display:flex; justify-content:space-between; border-bottom:2px solid #2c3e50; padding-bottom:3px; margin-bottom:8px;">
                <h1 style="font-size:13pt; margin:0; color:#2c3e50;">–ë–õ–û–ö ‚Ññ${c}</h1>
                <span style="font-size:9pt;">–°–æ–∑–¥–∞–Ω: ${dateStr}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px;">`;

        for (let w = 1; w <= 4; w++) {
            fullHtml += `<div>
                <div style="background:#2c3e50; color:#fff; text-align:center; font-weight:bold; font-size:8pt; padding:2px;">–ù–ï–î–ï–õ–Ø ${w}</div>`;
            
            ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(day => {
                // –ü–û–õ–£–ß–ê–ï–ú –î–ê–¢–£ –ò–ó –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ ID, —á—Ç–æ –∏ –≤ renderMain)
                const savedDateValue = globalData[`c${c}_w${w}${day}dt`];
                let displayDate = "";
                if (savedDateValue) {
                    const d = new Date(savedDateValue);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ –î–î.–ú–ú
                    if (!isNaN(d.getTime())) {
                        displayDate = d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
                    }
                }

                let dayTotalVolume = 0;
                let tableRowsHtml = '';
                [['mu','–í—ã—Ö–æ–¥—ã'], ['d','–ë—Ä—É—Å—å—è'], ['p','–¢—É—Ä–Ω–∏–∫']].forEach(([type, fullName]) => {
                    const sMax = (type === 'mu') ? 5 : (day === "–ß–µ—Ç–≤–µ—Ä–≥" ? 3 : (w === 4 ? 2 : 5));
                    let exerciseVolume = 0;
                    let cellsHtml = '';
                    
                    for(let s=1; s<=5; s++) {
                        const id = `c${c}_w${w}${day}${type}${s}`;
                        if (s <= sMax) {
                            const pW = parseFloat(globalData[id+'w']) || 0;
                            const pR = parseInt(globalData[id+'r']) || 0;
                            const isDone = globalData[id+'c'] === 'true' || globalData[id+'c'] === true;
                            
                            if(isDone) {
                                exerciseVolume += (pW * pR);
                                if(s === 1) stats[type].push(pW);
                            }

                            cellsHtml += `<td style="width:10%; border:1px solid #000; text-align:center; line-height:1.1; background:${isDone ? '#d4edda' : '#f8d7da'}; -webkit-print-color-adjust: exact;">
                                <div style="font-weight:bold; font-size:7.5pt;">${pW}</div>
                                <div style="font-size:6pt; border-top:0.5px solid rgba(0,0,0,0.1);">${pR}</div>
                            </td>`;
                        } else {
                            cellsHtml += `<td style="width:10%; border:1px solid #000; background:#f0f0f0;"></td>`;
                        }
                    }

                    dayTotalVolume += exerciseVolume;
                    tableRowsHtml += `<tr>
                        <td style="width:50%; text-align:left; padding-left:3px; border:1px solid #000; font-size:7pt;">
                            <b>${fullName}</b><br>
                            <span style="font-size:5.5pt; color:#7f8c8d;">–û–±—ä–µ–º: ${exerciseVolume} –∫–≥</span>
                        </td>
                        ${cellsHtml}
                    </tr>`;
                });

                fullHtml += `
                <table style="width:100%; border-collapse: collapse; margin-top:3px; table-layout: fixed; border: 1px solid #000;">
                    <thead>
                        <tr style="background:#eee;">
                            <th colspan="6" style="font-size:7pt; border:1px solid #000; padding:1px; position:relative;">
                                ${day} ${displayDate ? '(' + displayDate + ')' : ''}
                                <span style="position:absolute; right:5px; font-weight:normal; color:#555;">‚àë ${dayTotalVolume} –∫–≥</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody>${tableRowsHtml}</tbody>
                </table>`;
            });
            fullHtml += `</div>`;
        }
        fullHtml += `</div>`;

        // –ì–†–ê–§–ò–ö–ò (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        fullHtml += `<div style="display: flex; flex-direction: column; gap: 6px;">`;
        [['mu','–í—ã—Ö–æ–¥—ã –Ω–∞ –¥–≤–µ'], ['d','–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö'], ['p','–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è –Ω–∞ —Ç—É—Ä–Ω–∏–∫–µ']].forEach(([t, label]) => {
            const shortKey = t === 'mu' ? 'mu' : (t === 'd' ? 'd' : 'p');
            const weights = stats[shortKey];
            if (!weights.length) return;

            const n = weights.length;
            const maxW = Math.max(...weights, 1);
            const minW = Math.min(...weights);
            const range = (maxW - minW) || 10;

            let sX=0, sY=0, sXY=0, sX2=0;
            weights.forEach((y, x) => { sX+=x; sY+=y; sXY+=x*y; sX2+=x*x; });
            const m = n > 1 ? (n*sXY - sX*sY) / (n*sX2 - sX*sX) : 0;
            const b = (sY - m*sX) / n;

            const getP = (val, i) => ({
                x: (i / (n - 1 || 1)) * 360 + 20,
                y: 45 - ((val - minW) / range) * 30
            });

            const pts = weights.map((v, i) => `${getP(v, i).x},${getP(v, i).y}`).join(' ');
            const tS = getP(b, 0);
            const tE = getP(m * (n - 1) + b, n - 1);

            fullHtml += `
            <div style="width:100%; border:1px solid #bdc3c7; padding:4px; height:70px; background:#fff;">
                <div style="font-size:7pt; font-weight:bold; margin-bottom:2px; display:flex; justify-content:space-between; padding:0 10px;">
                    <span>${label}</span>
                    <span style="font-size:5.5pt; color:#27ae60;">–õ–∏–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞ (–ø—Ä–æ–≥—Ä–µ—Å—Å)</span>
                </div>
                <svg viewBox="0 0 400 55" style="width:100%; height:55px;">
                    <line x1="20" y1="45" x2="380" y2="45" stroke="#7f8c8d" stroke-width="1" />
                    <line x1="${tS.x}" y1="${tS.y}" x2="${tE.x}" y2="${tE.y}" stroke="#27ae60" stroke-width="1" stroke-dasharray="4,2" opacity="0.6" />
                    <polyline points="${pts}" fill="none" stroke="#2980b9" stroke-width="1.5" />
                    ${weights.map((v, i) => {
                        const p = getP(v, i);
                        return `<circle cx="${p.x}" cy="${p.y}" r="2" fill="#2c3e50" />
                                <text x="${p.x}" y="${p.y-4}" font-size="6" font-weight="bold" text-anchor="middle">${v}</text>`;
                    }).join('')}
                </svg>
            </div>`;
        });
        fullHtml += `</div>`;

        // –ó–ê–ú–ï–¢–ö–ò (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        let rawNotes = globalData[`c${c}_notes`] || "–ó–∞–º–µ—Ç–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.";
        let formattedNotes = rawNotes
            .replace(/\n/g, '<br>')
            .replace(/^- (.*)/gm, '<li>$1</li>')
            .replace(/^(\d+)\. (.*)/gm, '<li>$2</li>');
        if (formattedNotes.includes('<li>')) formattedNotes = `<ul style="margin: 0; padding-left: 15px;">${formattedNotes}</ul>`;

        fullHtml += `
        <div style="margin-top: 10px; padding: 8px; border: 1px solid #2c3e50; background: #fdfdfd;">
            <div style="font-size: 8pt; font-weight: bold; border-bottom: 1px solid #eee; margin-bottom: 4px;">üìù –ó–ê–ú–ï–¢–ö–ò –ë–õ–û–ö–ê:</div>
            <div style="font-size: 7.5pt; color: #333; line-height: 1.3;">${formattedNotes}</div>
        </div>`;

        fullHtml += `</div>`;
    }

    printSection.innerHTML = fullHtml;
    document.body.appendChild(printSection);
    window.print();
}

// –∑–∞–º–µ—Ç–∫–∏
// –§—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞
function syncNotes(text) {
    const cId = curC; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–∏–∫–ª
    if (!cId) return;

    const key = `c${cId}_notes`;
    globalData[key] = text; 
    
    // –ó–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ç–≤–æ—é —Ä–∞–±–æ—á—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    save(key, text); 
}

// –î–æ–±–∞–≤—å –≤—ã–∑–æ–≤ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ —Ç—ã –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—à—å —Ü–∏–∫–ª—ã –∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—à—å –¥–∞–Ω–Ω—ã–µ
function refreshNotesField() {
    const cId = curC; // —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–∏–∫–ª
    const field = document.getElementById('cycle-notes');
    if (field) {
        field.value = globalData[`c${cId}_notes`] || "";
        // –ü–æ–¥–≥–æ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–¥ —Ç–µ–∫—Å—Ç
        field.style.height = '';
        field.style.height = field.scrollHeight + 'px';
    }
}

// —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
// –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ (–¥–æ–±–∞–≤—å —ç—Ç–æ –≤ –Ω–∞—á–∞–ª–æ —Å–≤–æ–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –∏–ª–∏ –≤ HTML)
if (!document.getElementById('html2canvas-lib')) {
    const script = document.createElement('script');
    script.id = 'html2canvas-lib';
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    document.head.appendChild(script);
}


function generateShareCard() {
    let dayTotal = 0;
    let totalSets = 0;
    let activeExercises = [];
    
    const types = [
        {id: 'mu', name: '–í—ã—Ö–æ–¥—ã'}, {id: 'd', name: '–ë—Ä—É—Å—å—è'}, {id: 'p', name: '–¢—É—Ä–Ω–∏–∫'}
    ];

    types.forEach(ex => {
        let setsData = [];
        let exVolume = 0;
        for(let s=1; s<=5; s++) {
            const id = `c${curC}_w${curW}${curD}${ex.id}${s}`;
            if(globalData[id+'c'] === 'true' || globalData[id+'c'] === true) {
                const w = parseFloat(globalData[id+'w']) || 0;
                const r = parseInt(globalData[id+'r']) || 0;
                exVolume += (w * r);
                setsData.push({w, r});
            }
        }
        if(setsData.length > 0) {
            dayTotal += exVolume;
            totalSets += setsData.length;
            activeExercises.push({ ...ex, volume: exVolume, sets: setsData });
        }
    });

    if(dayTotal === 0) return;

    const count = activeExercises.length;
    const weightFontSize = count > 2 ? '18px' : '22px';
    const rowPadding = count > 2 ? '1px' : '3px';

const exercisesHtml = `
    <div style="display: block; width: 100%; height: auto;">
        ${activeExercises.map(ex => {
            const dynamicRowPadding = "4px"; 
            const weightFontSize = "20px";
            const weightFontWeight = "800";

            return `
                <div style="background:#f2f2f7; border-radius:14px; padding:6px; display: block; border: 1px solid #e5e5ea; box-sizing: border-box; margin-bottom: 8px; width: 100%; height: fit-content;">
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px; padding: 0 24px; height: 30px;">
                        <span style="font-size: 14px; font-weight:800; color:#000; letter-spacing:-0.2px;">${ex.name.toUpperCase()}</span>
                        <div style="background: #d1d1d6; min-width: 55px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                            <span style="font-size: 8px; font-weight:700; color:#000;">${ex.volume} KG</span>
                        </div>
                    </div>

                    <div style="background:#fff; border-radius:10px; display: block; border: 1px solid #efeff4; overflow: hidden; height: fit-content;">
                        ${ex.sets.map((set, i) => `
                            <div style="display:flex; justify-content:space-between; align-items:center; background: ${i % 2 === 0 ? '#fff' : '#f9f9fb'}; border-bottom: ${i === ex.sets.length - 1 ? 'none' : '1px solid #f2f2f7'}; padding: ${dynamicRowPadding} 24px; position: relative; height: 32px; box-sizing: border-box;">
                                
                                <div style="display: flex; align-items: center; z-index: 2;">
                                    <span style="background: #d1d1d6; color: #000; font-size: 10px; font-weight: 900; width: 14px; height: 14px; display: flex; align-items: center; justify-content: center; border-radius: 3px;">${i+1}</span>
                                </div>
                                
                                <div style="position: absolute; left: 40%; top: 50%; transform: translate(-50%, -50%); display: flex; gap: 2px; opacity: 0.5; z-index: 1;">
                                    <div style="width: 2px; height: 10px; background: #000; transform: skewX(-20deg);"></div>
                                    <div style="width: 2px; height: 10px; background: #000; transform: skewX(-20deg);"></div>
                                </div>
                                
                                <div style="display: flex; align-items: baseline; z-index: 2;">
                                    <span style="font-weight:${weightFontWeight}; color:#000; font-size: ${weightFontSize}; letter-spacing:-0.5px;">${set.w}</span>
                                    <span style="font-size: 10px; font-weight:700; color:#aeaeb2; margin-left: 3px; text-transform: uppercase;">kg</span>
                                    <span style="font-size:12px; font-weight:400; color:#000; margin: 0 5px;">X</span>
                                    <span style="font-weight:${weightFontWeight}; color:#000; font-size: ${weightFontSize}; letter-spacing:-0.5px;">${set.r}</span>
                                    <span style="font-size: 7px; font-weight:700; color:#aeaeb2; margin-left: 3px; text-transform: uppercase;">–ø–æ–≤—Ç</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }).join('')}
    </div>
`;

    const overlay = document.createElement('div');
    overlay.id = "share-overlay";
    overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:100000; display:flex; flex-direction:column; font-family:-apple-system, system-ui, sans-serif; box-sizing:border-box; overflow: hidden;";

    overlay.innerHTML = `
        <div id="ignore-1" onclick="document.getElementById('share-overlay').remove()" style="position:absolute; top:15px; right:20px; color:#eee; font-size:18px; cursor:pointer; z-index:110;">‚úï</div>

        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%) rotate(-15deg); font-size:110px; font-weight:900; color:rgba(0,0,0,0.02); white-space:nowrap; z-index:1; pointer-events:none; user-select:none;">
            ${new Date().toLocaleString('ru-RU', {month: 'long'}).toUpperCase()}
        </div>

        <div id="capture-area" style="flex:1; display:flex; flex-direction:column; padding: 20px 15px 10px; box-sizing: border-box; min-height:0; background:#fff; position:relative; z-index:2;">
            <div style="margin-bottom: 15px; flex-shrink: 0; border-bottom: 2px solid #000; padding: 0 30px 8px 30px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <div>
                        <div style="font-size: 9px; font-weight: 800; color: #8e8e93; margin-bottom: 2px;">${new Date().toLocaleDateString('ru-RU')}</div>
                        <div style="font-size: 34px; font-weight: 800; color: #000; letter-spacing: 0px; line-height: 0.85;">${curD.toUpperCase()}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: 900; color: #000; line-height: 0.85;">${dayTotal}</div>
                        <div style="font-size: 8px; color: #8e8e93; font-weight: 800; text-transform: uppercase;">–ö–ì –¢–æ–Ω–Ω–∞–∂</div>
                    </div>
                </div>
                <div style="font-size: 10px; color:#000; font-weight: 900; margin-top: 10px; display: flex; justify-content: space-between; text-transform: uppercase;">
                    <span>–ë–ª–æ–∫ ${curC} ‚Ä¢ –ù–µ–¥–µ–ª—è ${curW}</span>
                    <span>–ü–æ–¥—Ö–æ–¥–æ–≤: ${totalSets}</span>
                </div>
            </div>

            <div style="flex: 1; display: grid; grid-template-rows: repeat(${count}, 1fr); gap: 10px; min-height: 0;">
                ${exercisesHtml}
            </div>

            <div style="padding: 12px 0 5px; display: flex; justify-content: center; align-items: center; gap: 12px; flex-shrink: 0;">
                <div style="font-size: 13px; font-weight: 900; color: #000; letter-spacing: 0.5px; padding-left: 45 px;">STREETLIFTING PRO</div>
                <div id="ignore-2" onclick="saveAsImage()" style="width:22px; height:22px; background:#000; border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏
async function saveAsImage() {
    const area = document.getElementById('capture-area');
    const closeBtn = document.getElementById('ignore-1');
    const downloadBtn = document.getElementById('ignore-2');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ª–∏—à–Ω–µ–µ –ø–µ—Ä–µ–¥ —Å–Ω–∏–º–∫–æ–º
    downloadBtn.style.visibility = 'hidden';
    closeBtn.style.visibility = 'hidden';

    const canvas = await html2canvas(area, { 
        scale: 3, 
        backgroundColor: "#ffffff",
        useCORS: true 
    });
    
    const dataUrl = canvas.toDataURL("image/png");

    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω–Ω—ã–π —Å–ª–æ–π —Å –≥–æ—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–æ–π
    const previewOverlay = document.createElement('div');
    previewOverlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100001; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
    
    previewOverlay.innerHTML = `
        <div style="color:#fff; font-size:14px; font-weight:800; margin-bottom:15px; text-align:center; font-family:sans-serif;">–ó–ê–ñ–ú–ò –ö–ê–†–¢–ò–ù–ö–£, –ß–¢–û–ë–´ –°–û–•–†–ê–ù–ò–¢–¨</div>
        <img src="${dataUrl}" style="width:100%; max-height:80vh; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.5);" />
        <div onclick="this.parentElement.remove()" style="margin-top:20px; color:#fff; font-size:12px; font-weight:600; text-decoration:underline; cursor:pointer; font-family:sans-serif;">–ó–ê–ö–†–´–¢–¨ –ü–†–ï–í–¨–Æ</div>
    `;

    document.body.appendChild(previewOverlay);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∞–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –æ–∫–Ω–µ
    downloadBtn.style.visibility = 'visible';
    closeBtn.style.visibility = 'visible';
}
// —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ
function toggleNotes() {
    const content = document.getElementById('notes-content');
    const icon = document.getElementById('notes-icon');
    
    const isCollapsed = content.classList.toggle('collapsed');
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏: 0 –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ, -90 –µ—Å–ª–∏ –∑–∞–∫—Ä—ã—Ç–æ
    icon.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
}

    function toggleBlock(id, header) { document.getElementById('content-' + id).classList.toggle('collapsed'); header.classList.toggle('collapsed-header'); }
    function closeWarmup() { document.getElementById('warmup-overlay').style.display = 'none'; document.getElementById('warmup-modal').style.display = 'none'; }
    function openStats() { openModal('stats-modal'); updateChart('d', document.getElementById('st-d')); }
    function closeStats() { closeModal('stats-modal'); }
    function applyRPEStyle(el, val) { const conf = RPE_MAP[val] || RPE_MAP['none']; if(el){el.innerText = conf.label; el.style.backgroundColor = conf.color; el.style.color = conf.text;} }
    function cycleRPE(id) {
        const stages = ['none', 'easy', 'ok', 'hard', 'fail'];
        let cur = globalData[id+'rpe'] || 'none';
        let next = stages[(stages.indexOf(cur) + 1) % stages.length];
        applyRPEStyle(document.getElementById(id+'rpe'), next);
        save(id+'rpe', next);
    }
    function renderTabsUI() {
        const wt = document.getElementById('week-tabs'); wt.innerHTML = '';
        [1,2,3,4].forEach(i => wt.innerHTML += `<button class="tab-btn ${curW==i?'active':''}" onclick="switchWeek(${i})">–ù–µ–¥ ${i}<div class="progress-mini" id="pbar${i}"></div></button>`);
        const dt = document.getElementById('day-tabs-row'); dt.innerHTML = '';
        ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(d => dt.innerHTML += `<button class="day-btn ${curD==d?'active':''}" onclick="switchDay('${d}')">${d.substring(0,2)}</button>`);
    }
    function updateAllProgress() {
        [1,2,3,4].forEach(w => {
            let t = 0, c = 0;
            ["–í—Ç–æ—Ä–Ω–∏–∫", "–ß–µ—Ç–≤–µ—Ä–≥", "–°—É–±–±–æ—Ç–∞"].forEach(day => {
                ['mu','d','p'].forEach(ex => {
                    let sMax = getSetsCount(ex, w, day);
                    for(let s=1; s<=sMax; s++) { t++; if(globalData[`c${curC}_w${w}${day}${ex}${s}c`] == 'true' || globalData[`c${curC}_w${w}${day}${ex}${s}c`] === true) c++; }
                });
            });
            if(document.getElementById(`pbar${w}`)) document.getElementById(`pbar${w}`).style.width = (c/t*100) + '%';
        });
    }
    function getSetsCount(type, week, day) { if (type === 'mu') return 5; if (day === "–ß–µ—Ç–≤–µ—Ä–≥") return 3; if (week === 4) return 2; return 5; }
    function resetT() { if(tInt) clearInterval(tInt); document.getElementById('t-display').style.display='none'; document.getElementById('t-setup').style.display='flex'; document.getElementById('t-btn').innerText = '–°–¢–ê–†–¢'; }
    function closeTimer() { document.getElementById('timer-widget').style.display = 'none'; resetT(); }
    function runTimer() {
        let btn = document.getElementById('t-btn'), disp = document.getElementById('t-display'), setup = document.getElementById('t-setup');
        if(btn.innerText === '–°–¢–ê–†–¢') {
            btn.innerText = '–°–¢–û–ü';
            let t = (parseInt(document.getElementById('t-min').value)||0)*60 + (parseInt(document.getElementById('t-sec').value)||0);
            setup.style.display = 'none'; disp.style.display = 'block';
            tInt = setInterval(() => {
                let m = Math.floor(t/60), s = t%60; disp.innerText = `${m}:${s<10?'0':''}${s}`;
                if(--t < 0) { clearInterval(tInt); btn.innerText = '–û–ö'; }
            }, 1000);
        } else { resetT(); if(btn.innerText === '–û–ö') document.getElementById('timer-widget').style.display = 'none'; }
    }
    function switchCycle(n) { curC = n; initInterface(); }
    function switchWeek(n) { curW = n; renderMain(); save(`c${curC}_actW`, n); updateAllProgress(); }
    function switchDay(d) { curD = d; renderMain(); save(`c${curC}_actD`, d); updateAllProgress(); }
    function openModal(id){ document.getElementById(id).style.display='flex'; }
    function closeModal(id){ document.getElementById(id).style.display='none'; }





    load();
</script>
</body>
</html>